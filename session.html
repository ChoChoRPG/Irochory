<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Irochori - Sesi Belajar</title>
    <!-- Tautan ke CSS Kustom Anda -->
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- Ikon Favicon -->
    <link rel="icon" href="assets/img/logo.svg">
</head>
<body>

    <main class="container">

        <!-- ===== 2. Layar Flashcard ===== -->
        <section id="flashcard-screen" class="screen active"> 
            <!-- Progress Bar -->
            <div class="progress-bar">
                <span id="progress-text">1 / ...</span>
                <button id="exit-button" class="btn-exit">Keluar</button>
            </div>
            
            <!-- Card Container -->
            <div id="card-container" class="card-container">
                <div id="card-inner" class="card-inner">
                    <!-- Bagian Depan (Kanji) -->
                    <div id="card-front" class="card-face card-front">
                        <span id="card-kanji" class="kanji-text">Memuat...</span>
                    </div>
                    <!-- Bagian Belakang (Furigana + Arti) -->
                    <div id="card-back" class="card-face card-back">
                        <span id="card-furigana" class="furigana-text"></span>
                        <span id="card-arti" class="arti-text"></span>
                    </div>
                </div>
            </div>

            <!-- Tombol Benar / Salah -->
            <div id="answer-buttons" class="answer-buttons">
                <!-- INI TOMBOL SALAH YANG ANDA MAKSUD -->
                <button id="incorrect-button" class="btn btn-circle btn-incorrect">
                    <img src="assets/img/silang.svg" alt="Salah" class="icon-large">
                </button>
                <button id="tts-button" class="btn btn-circle btn-tts">
                    <img src="assets/img/audio.svg" alt="Audio" class="icon-large">
                </button>
                <button id="correct-button" class="btn btn-circle btn-correct">
                    <img src="assets/img/ceklis.svg" alt="Benar" class="icon-large">
                </button>
            </div>
        </section>

        <!-- ===== 3. Layar Hasil ===== -->
        <section id="results-screen" class="screen hidden">
            <div class="card results-card">
                <h2 class="screen-title">Sesi Selesai!</h2>
                <p class="score-label">Skor Anda:</p>
                <div id="score-display" class="score-display">0 / 0</div>

                <!-- INI ADALAH TABEL UNTUK REVIEW KANJI YANG SALAH -->
                <div id="incorrect-list-container" class="incorrect-container hidden">
                    <h3 class="incorrect-title">Daftar Kesalahan:</h3>
                    <div class="table-wrapper">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Kanji</th>
                                    <th>Furigana</th>
                                    <th>Arti</th>
                                </tr>
                            </thead>
                            <tbody id="incorrect-list-tbody">
                                <!-- Daftar kesalahan akan dimasukkan oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <button id="restart-button" class="btn btn-primary btn-restart">
                    Coba Lagi
                </button>
            </div>
        </section>

    </main>

    <!-- JavaScript Khusus untuk Sesi Ini (Inline) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === Global State ===
            let originalDeck = []; 
            let currentDeck = [];
            let currentCardIndex = 0;
            let score = 0;
            let incorrectAnswers = []; 
            let synth = window.speechSynthesis;
            let utterance = new SpeechSynthesisUtterance();
            let wasShuffledInitially = false; 

            // === DOM Element Selectors ===
            // (PERBAIKAN) Membungkus selector dalam try...catch untuk debugging
            let screens, exitButton, progressText, cardContainer, cardInner, cardKanji, cardFurigana, cardArti, answerButtons, correctButton, incorrectButton, ttsButton, scoreDisplay, incorrectContainer, incorrectTbody, restartButton;
            
            try {
                screens = {
                    flashcard: document.getElementById('flashcard-screen'),
                    results: document.getElementById('results-screen'),
                };
                exitButton = document.getElementById('exit-button');
                progressText = document.getElementById('progress-text');
                cardContainer = document.getElementById('card-container');
                cardInner = document.getElementById('card-inner');
                cardKanji = document.getElementById('card-kanji');
                cardFurigana = document.getElementById('card-furigana');
                cardArti = document.getElementById('card-arti');
                answerButtons = document.getElementById('answer-buttons');
                correctButton = document.getElementById('correct-button');
                incorrectButton = document.getElementById('incorrect-button');
                ttsButton = document.getElementById('tts-button');
                scoreDisplay = document.getElementById('score-display');
                incorrectContainer = document.getElementById('incorrect-list-container');
                incorrectTbody = document.getElementById('incorrect-list-tbody'); 
                restartButton = document.getElementById('restart-button');

                // Cek jika ada yang null
                if (!screens.flashcard || !screens.results || !scoreDisplay || !incorrectTbody || !incorrectContainer) {
                    throw new Error("Satu atau lebih elemen DOM penting tidak ditemukan.");
                }

            } catch (e) {
                console.error("Fatal Error saat mengambil elemen DOM:", e.message);
                document.body.innerHTML = `<div style="color: red; padding: 2rem;">Error Kritis: ${e.message}. Cek ID elemen di HTML.</div>`;
                return; // Stop eksekusi
            }

            // === Logika Utama Sesi ===
            function initializeSession() {
                const deckDataString = localStorage.getItem('irochoriDeck');
                const shuffleDataString = localStorage.getItem('irochoriShuffle'); 

                if (!deckDataString) {
                    console.error("Gagal memulai sesi (tidak ada data). HARUS MULAI DARI INDEX.HTML.");
                    document.body.innerHTML = `<div style="color: white; padding: 2rem; text-align: center; font-size: 1.25rem;">Gagal memuat sesi. Silakan mulai dari halaman <a href="./index.html" style="color: #3B82F6;">index.html</a> dan pilih materi.</div>`;
                    return;
                }

                try {
                    originalDeck = JSON.parse(deckDataString);
                    wasShuffledInitially = (shuffleDataString === 'true'); 
                    localStorage.removeItem('irochoriDeck'); 
                    localStorage.removeItem('irochoriShuffle'); 
                } catch (e) {
                    console.error("Gagal membaca data sesi.", e);
                    window.location.href = './index.html';
                    return;
                }

                if (originalDeck.length === 0) {
                    console.error("Sesi kosong. Anda akan dikembalikan ke menu.");
                    window.location.href = './index.html';
                    return;
                }
                
                setupEventListeners();
                startSession(wasShuffledInitially); 
            }
            
            function startSession(shuffleOnRestart = false) { 
                console.log("Memulai sesi. Acak:", shuffleOnRestart);
                currentDeck = [...originalDeck];
                
                if (shuffleOnRestart) {
                     for (let i = currentDeck.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [currentDeck[i], currentDeck[j]] = [currentDeck[j], currentDeck[i]];
                    }
                }
                
                // Reset state
                currentCardIndex = 0;
                score = 0;
                incorrectAnswers = []; 
                
                showScreen('flashcard');
                answerButtons.classList.remove('hidden');
                cardContainer.classList.remove('is-flipped', 'opacity-0', 'scale-95');
                incorrectContainer.classList.add('hidden'); 
                
                displayCard();
            }

            // === Event Listeners ===
            function setupEventListeners() {
                cardContainer.addEventListener('click', handleFlipCard);
                correctButton.addEventListener('click', () => handleAnswer(true));
                incorrectButton.addEventListener('click', () => handleAnswer(false));
                ttsButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleTTS();
                });
                
                restartButton.addEventListener('click', () => {
                    startSession(wasShuffledInitially);
                }); 
                
                exitButton.addEventListener('click', () => {
                    window.location.href = './index.html';
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === '=') handleAnswer(true);
                });
            }

            // (PERBAIKAN) Logika showScreen dibuat lebih eksplisit dan aman
            function showScreen(screenId) {
                console.log(`Menampilkan layar: ${screenId}`);
                
                // Sembunyikan semua layar
                if (screens.flashcard) {
                    screens.flashcard.classList.remove('active');
                    screens.flashcard.classList.add('hidden'); // Tambahan
                }
                if (screens.results) {
                    screens.results.classList.remove('active');
                    screens.results.classList.add('hidden'); // Tambahan
                }

                // Tampilkan layar yang diminta
                if (screenId === 'flashcard' && screens.flashcard) {
                    screens.flashcard.classList.add('active');
                    screens.flashcard.classList.remove('hidden');
                } else if (screenId === 'results' && screens.results) {
                    screens.results.classList.add('active');
                    screens.results.classList.remove('hidden');
                } else {
                    console.error(`Layar dengan ID '${screenId}' tidak ditemukan.`);
                }
            }

            function displayCard() {
                const card = currentDeck[currentCardIndex];
                if (!card) return; 

                cardKanji.textContent = card.kanji;
                cardFurigana.textContent = card.furigana;
                cardArti.textContent = card.arti;
                progressText.textContent = `${currentCardIndex + 1} / ${currentDeck.length}`;
                utterance.text = card.furigana;
                utterance.lang = 'ja-JP';
            }

            function handleFlipCard() {
                cardContainer.classList.toggle('is-flipped');
            }

            function handleAnswer(isCorrect) {
                cardContainer.classList.add('opacity-0', 'scale-95');

                if (isCorrect) {
                    score++;
                    correctButton.classList.add('flash-correct');
                    setTimeout(() => correctButton.classList.remove('flash-correct'), 500);
                } else {
                    incorrectAnswers.push(currentDeck[currentCardIndex]);
                    incorrectButton.classList.add('flash-incorrect');
                    setTimeout(() => incorrectButton.classList.remove('flash-incorrect'), 500);
                }

                setTimeout(() => {
                    currentCardIndex++;
                    
                    if (currentCardIndex >= currentDeck.length) {
                        console.log("Kartu habis. Menampilkan hasil...");
                        showResults(); // <-- PINDAH KE HASIL JIKA KARTU HABIS
                        return;
                    }

                    cardInner.style.transition = 'none';
                    cardContainer.classList.remove('is-flipped');
                    displayCard(); 
                    void cardInner.offsetWidth; 
                    cardInner.style.transition = 'transform 0.6s';
                    cardContainer.classList.remove('opacity-0', 'scale-95');

                }, 300);
            }

            function handleTTS() {
                if (synth.speaking) synth.cancel();
                synth.speak(utterance);
            }

            function showResults() {
                try {
                    console.log("Fungsi showResults() dipanggil.");
                    showScreen('results');
                    
                    console.log("Menampilkan skor...");
                    scoreDisplay.textContent = `${score} / ${currentDeck.length}`;
                    
                    console.log("Mengosongkan tabel...");
                    incorrectTbody.innerHTML = ''; // Kosongkan tabel dulu

                    console.log(`Jumlah jawaban salah: ${incorrectAnswers.length}`);
                    if (incorrectAnswers.length === 0) {
                        incorrectContainer.classList.add('hidden'); 
                    } else {
                        incorrectContainer.classList.remove('hidden'); 
                        
                        incorrectAnswers.forEach((card, index) => {
                            incorrectTbody.innerHTML += `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${card.kanji}</td>
                                    <td>${card.furigana}</td>
                                    <td>${card.arti}</td>
                                </tr>
                            `;
                        });
                        console.log("Tabel kesalahan selesai dibuat.");
                    }
                } catch (e) {
                    console.error("ERROR FATAL di dalam showResults():", e.message);
                    document.body.innerHTML = `<div style="color: red; padding: 2rem;">Error Kritis saat menampilkan hasil: ${e.message}. Cek konsol (F12) untuk detail.</div>`;
                }
            }
            
            // Jalankan
            console.log("Inisialisasi Sesi...");
            initializeSession();
        });
    </script>
</body>
</html>